# 🎭 Говорящий Аватар - Визуальная схема работы

## 🔄 Процесс обработки (пошагово)

```
┌─────────────────────────────────────────────────────────────┐
│  👤 ПОЛЬЗОВАТЕЛЬ                                             │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        │ 1. Вводит текст: "Привет!"
                        │    Выбирает язык: Русский
                        ↓
┌─────────────────────────────────────────────────────────────┐
│  🌐 ВЕБ-ИНТЕРФЕЙС (index.html)                              │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  • Textarea для текста                                │  │
│  │  • Radio buttons для языка                            │  │
│  │  • Кнопка "Озвучить"                                  │  │
│  │  • Video player для результата                        │  │
│  └───────────────────────────────────────────────────────┘  │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        │ 2. POST /api/generate
                        │    {text: "Привет!", language: "ru"}
                        ↓
┌─────────────────────────────────────────────────────────────┐
│  🚀 FLASK SERVER (app.py) - Порт 3000                       │
│                                                              │
│  ⚡ ПРЕДЗАГРУЖЕННЫЕ РЕСУРСЫ (в памяти):                     │
│  ├─ avatar_preloaded = cv2.imread(avatar.jpg)              │
│  └─ lipsync_service = LipsyncService(...)                   │
│       ├─ Wav2Lip model (139 MB)                             │
│       ├─ Face Detector (100 MB)                             │
│       └─ Audio Processor                                    │
└───────────────────────┬─────────────────────────────────────┘
                        │
        ┌───────────────┴────────────────┐
        │                                │
        ↓                                ↓
┌──────────────────┐          ┌─────────────────────┐
│  ЭТАП 1: TTS     │          │  ЭТАП 2: LIP-SYNC   │
│  (2-5 секунд)    │          │  (10-30 секунд)     │
└──────────────────┘          └─────────────────────┘

═══════════════════════════════════════════════════════════════

📍 ЭТАП 1: TTS ГЕНЕРАЦИЯ

┌─────────────────────────────────────────────────────────────┐
│  🎤 TTS API (tts.sk-ai.kz)                                  │
└───────────────────────────────────────────────────────────┬─┘
                                                            │
    POST {text: "Привет!", lang: "ru"}                     │
    ↓                                                       │
    Генерация речи...                                       │
    ↓                                                       │
    ← Возврат MP3 аудио                                    │
                                                            ↓
┌─────────────────────────────────────────────────────────────┐
│  🔄 КОНВЕРТАЦИЯ АУДИО (ffmpeg)                              │
│                                                              │
│  MP3 → WAV (16kHz, mono, PCM)                               │
│  Сохранение: temp_web/audio_TIMESTAMP.wav                   │
└───────────────────────────┬─────────────────────────────────┘
                            │
                            │ Готов WAV файл
                            ↓

═══════════════════════════════════════════════════════════════

📍 ЭТАП 2: LIP-SYNC ОБРАБОТКА

┌─────────────────────────────────────────────────────────────┐
│  🖼️  ШАГ A: ПОДГОТОВКА ИЗОБРАЖЕНИЯ                         │
│                                                              │
│  avatar_preloaded (уже в памяти!)                           │
│  ↓                                                           │
│  Face Detection (модель уже загружена!)                     │
│  ↓                                                           │
│  Координаты лица: (x1, y1, x2, y2)                          │
│  Кроп изображения: face_crop                                │
└───────────────────────────┬─────────────────────────────────┘
                            │
┌───────────────────────────┴─────────────────────────────────┐
│  🎵 ШАГ B: ОБРАБОТКА АУДИО                                  │
│                                                              │
│  audio.wav                                                   │
│  ↓                                                           │
│  Извлечение mel-spectrogram (librosa)                       │
│  ↓                                                           │
│  Разделение на chunks по 16 фреймов                         │
│  mel_chunks = [chunk1, chunk2, ..., chunkN]                 │
└───────────────────────────┬─────────────────────────────────┘
                            │
┌───────────────────────────┴─────────────────────────────────┐
│  🎬 ШАГ C: WAV2LIP ИНФЕРЕНС                                 │
│                                                              │
│  Для каждого batch (128 chunks):                            │
│    ┌──────────────────────────────────────────────────┐    │
│    │  Input:                                          │    │
│    │  • face_crop (96x96x3)                           │    │
│    │  • mel_chunk (80x16)                             │    │
│    │                                                   │    │
│    │  Wav2Lip Model (уже в памяти!)                   │    │
│    │  ↓                                                │    │
│    │  Output: synced_face (96x96x3)                   │    │
│    └──────────────────────────────────────────────────┘    │
│                                                              │
│  Результат: List[synced_frames]                             │
└───────────────────────────┬─────────────────────────────────┘
                            │
┌───────────────────────────┴─────────────────────────────────┐
│  🎥 ШАГ D: СБОРКА ВИДЕО                                     │
│                                                              │
│  1. Создание temp/result.avi:                               │
│     • Вставка synced_faces в оригинальные фреймы            │
│     • Запись в VideoWriter (25 FPS)                         │
│                                                              │
│  2. Объединение с аудио (ffmpeg):                           │
│     temp/result.avi + temp/audio.wav                        │
│     ↓                                                        │
│     outputs/avatar_TIMESTAMP.mp4                            │
└───────────────────────────┬─────────────────────────────────┘
                            │
                            │ Готово видео!
                            ↓

═══════════════════════════════════════════════════════════════

┌─────────────────────────────────────────────────────────────┐
│  📤 ВОЗВРАТ РЕЗУЛЬТАТА                                       │
│                                                              │
│  Flask Server → Браузер                                     │
│  • Content-Type: video/mp4                                  │
│  • Binary data: avatar_TIMESTAMP.mp4                        │
└───────────────────────────┬─────────────────────────────────┘
                            │
                            ↓
┌─────────────────────────────────────────────────────────────┐
│  🌐 ВЕБ-ИНТЕРФЕЙС                                            │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  📺 VIDEO PLAYER                                      │  │
│  │  ┌───────────────────────────────────────────────┐   │  │
│  │  │                                               │   │  │
│  │  │     [▶ Видео с говорящим аватаром]           │   │  │
│  │  │                                               │   │  │
│  │  └───────────────────────────────────────────────┘   │  │
│  │                                                       │  │
│  │  [💾 Скачать видео]                                  │  │
│  └───────────────────────────────────────────────────────┘  │
└───────────────────────────┬─────────────────────────────────┘
                            │
                            ↓
┌─────────────────────────────────────────────────────────────┐
│  👤 ПОЛЬЗОВАТЕЛЬ                                             │
│  • Смотрит видео                                            │
│  • Скачивает результат                                      │
│  • Может сделать новый запрос!                              │
└─────────────────────────────────────────────────────────────┘

═══════════════════════════════════════════════════════════════

⏱️  ИТОГОВОЕ ВРЕМЯ:

┌────────────────────────┬─────────┬─────────┐
│  Этап                  │  CPU    │  GPU    │
├────────────────────────┼─────────┼─────────┤
│  TTS генерация         │  2-5s   │  2-5s   │
│  Конвертация аудио     │  1-2s   │  1-2s   │
│  Face detection        │  2-4s   │  1-2s   │
│  Wav2Lip inference     │  20-40s │  5-10s  │
│  Сборка видео          │  1-2s   │  1-2s   │
├────────────────────────┼─────────┼─────────┤
│  ИТОГО                 │  30-60s │  12-25s │
└────────────────────────┴─────────┴─────────┘

🎯 КЛЮЧЕВОЕ ПРЕИМУЩЕСТВО:
   Модели загружаются ОДИН РАЗ при старте
   → Последующие запросы БЫСТРЫЕ!
```

## 💾 Использование памяти

```
┌─────────────────────────────────────────────────────┐
│  ПАМЯТЬ (RAM)                                       │
├─────────────────────────────────────────────────────┤
│  Flask Server            ~50 MB                     │
│  Wav2Lip Model           ~200 MB  ← В ПАМЯТИ       │
│  Face Detector           ~100 MB  ← В ПАМЯТИ       │
│  Avatar Image            ~2 MB    ← В ПАМЯТИ       │
│  Audio Processor         ~50 MB                     │
│  Временные буферы        ~100 MB                    │
├─────────────────────────────────────────────────────┤
│  ИТОГО                   ~500 MB                    │
└─────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────┐
│  ВИДЕОПАМЯТЬ (VRAM) - При использовании GPU         │
├─────────────────────────────────────────────────────┤
│  Модели на GPU           ~300 MB                    │
│  Батчи для обработки     ~200 MB                    │
├─────────────────────────────────────────────────────┤
│  ИТОГО                   ~500 MB                    │
└─────────────────────────────────────────────────────┘
```

## 🔄 Параллельная обработка

```
Запрос 1 ──────────────────────────────► [Обработка 30s]
                ↓
            [Использует предзагруженные модели]
                ↓
Запрос 2 ──────────► [Ждет] ───────────► [Обработка 30s]
                                  ↓
                        [Те же модели в памяти!]

ВАЖНО: 
• Модели общие для всех запросов
• Нет повторной загрузки
• Экономия времени на каждом запросе
```

## 🎨 Веб-интерфейс (Структура)

```
┌──────────────────────────────────────────────────┐
│  🎭 Говорящий Аватар                             │
│  Введите текст и получите видео с говорящим...   │
├──────────────────────────────────────────────────┤
│                                                  │
│           ┌────────────────────┐                 │
│           │                    │                 │
│           │   [Фото аватара]   │                 │
│           │                    │                 │
│           └────────────────────┘                 │
│                                                  │
├──────────────────────────────────────────────────┤
│  ✍️ Текст для озвучки:                           │
│  ┌────────────────────────────────────────────┐  │
│  │ Введите текст, который должен произнести   │  │
│  │ аватар...                                  │  │
│  └────────────────────────────────────────────┘  │
│                                                  │
│  🌍 Язык озвучки:                                │
│  [ 🇷🇺 Русский ] [ 🇰🇿 Казахский ] [ 🇬🇧 Англ ] │
│                                                  │
│  ┌────────────────────────────────────────────┐  │
│  │     🎤 Озвучить и создать видео            │  │
│  └────────────────────────────────────────────┘  │
│                                                  │
│  ⏳ Генерация озвучки...                         │
│                                                  │
└──────────────────────────────────────────────────┘

После обработки:

┌──────────────────────────────────────────────────┐
│           ┌────────────────────┐                 │
│           │  📺 [▶ VIDEO]      │                 │
│           │                    │                 │
│           └────────────────────┘                 │
│                                                  │
│  ✅ Видео готово!                                │
│                                                  │
│  📊 Статистика обработки:                        │
│  • Общее время: 25.3s                            │
│  • TTS генерация: 3.2s                           │
│  • Lip-sync: 22.1s                               │
│                                                  │
│  [ 💾 Скачать видео ]                            │
└──────────────────────────────────────────────────┘
```

---

**Визуальная схема создана для понимания архитектуры системы**
