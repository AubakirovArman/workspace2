# 🎨 Визуальная схема: Параллельная обработка

## 📊 Архитектура системы

```
┌───────────────────────────────────────────────────────────────┐
│                    Веб-клиент (Браузер)                        │
│  http://localhost:3000/parallel_test                           │
└─────────────────────────────┬─────────────────────────────────┘
                              │
                   ┌──────────┴──────────┐
                   │                     │
                   ↓                     ↓
    ┌──────────────────────┐  ┌──────────────────────┐
    │ POST /api/generate   │  │ POST /api/generate_  │
    │   (обычная)          │  │   parallel           │
    │                      │  │   (быстрая) ⚡        │
    └──────┬───────────────┘  └──────┬───────────────┘
           │                         │
           ↓                         ↓
    ┌──────────────────────┐  ┌──────────────────────────────┐
    │ Sequential           │  │ Parallel Processing          │
    │ Processing           │  │                              │
    │                      │  │ 1. Split audio               │
    │ GAN model only       │  │ 2. Process chunks in ||      │
    │                      │  │ 3. Merge videos              │
    └──────────────────────┘  └──────────────────────────────┘
```

## 🔄 Сравнение процессов

### Обычная обработка (Sequential)

```
┌─────────────────────────────────────────────────────────────┐
│                    ОБЫЧНАЯ ОБРАБОТКА                         │
└─────────────────────────────────────────────────────────────┘

TTS API → Audio → GAN Model → Video
  (3s)     (1s)     (12s)      (1s)

Время: 17s

┌────────────────────────────────────────────────────┐
│ ████████████████████████████████ GAN обработка     │
└────────────────────────────────────────────────────┘
0s                                                  17s
```

### Параллельная обработка (Parallel)

```
┌─────────────────────────────────────────────────────────────┐
│                 ПАРАЛЛЕЛЬНАЯ ОБРАБОТКА                       │
└─────────────────────────────────────────────────────────────┘

TTS API → Audio → Split → ┌─ GAN (chunk 1)  ─┐ → Merge → Video
  (3s)     (1s)   (0.3s)  │                  │   (0.5s)   (1s)
                          └─ NOGAN (chunk 2) ─┘
                               (6.8s)

Время: 9.8s

┌────────────────────────────────────────────────────┐
│ ████████████ GAN                                   │
│ ████████████ NOGAN                                 │
│              ▓▓▓▓ Merge                            │
└────────────────────────────────────────────────────┘
0s                                                 9.8s

Ускорение: 1.73x ⚡
```

## 📦 Детальный процесс параллельной обработки

```
┌─────────────────────────────────────────────────────────┐
│ Шаг 1: Генерация и подготовка аудио                    │
└─────────────────────────────────────────────────────────┘

User Input: "Длинный текст..."
     │
     ↓
┌──────────┐
│ TTS API  │ → MP3 (3.2s)
└────┬─────┘
     ↓
┌──────────┐
│ Convert  │ → WAV 16kHz (1.1s)
└────┬─────┘
     ↓
   Audio: 20.5 секунд


┌─────────────────────────────────────────────────────────┐
│ Шаг 2: Разбиение на оптимальное количество чанков      │
└─────────────────────────────────────────────────────────┘

┌────────────────────┐
│ estimate_optimal_  │
│ chunks()           │
│                    │
│ 20.5s / 15s = 1.36 │
│ → 2 chunks         │
└────┬───────────────┘
     ↓
┌────────────────────┐
│ split_audio_file() │
└────┬───────────────┘
     │
     ├─→ chunk_0.wav (0.0s - 10.25s)
     │
     └─→ chunk_1.wav (10.25s - 20.5s)


┌─────────────────────────────────────────────────────────┐
│ Шаг 3: Параллельная обработка на двух моделях          │
└─────────────────────────────────────────────────────────┘

ThreadPoolExecutor (max_workers=2)
     │
     ├─→ Thread 1: GAN Service
     │   │
     │   ├─ Load cached face (0s)
     │   ├─ Process audio (1.2s)
     │   ├─ Face detection (0s, cached)
     │   └─ Inference (5.3s)
     │   
     │   Result: chunk_0.mp4 (6.5s)
     │
     └─→ Thread 2: NOGAN Service
         │
         ├─ Load cached face (0s)
         ├─ Process audio (1.3s)
         ├─ Face detection (0s, cached)
         └─ Inference (5.5s)
         
         Result: chunk_1.mp4 (6.8s)

Параллельное время: max(6.5s, 6.8s) = 6.8s


┌─────────────────────────────────────────────────────────┐
│ Шаг 4: Склейка видео чанков                            │
└─────────────────────────────────────────────────────────┘

┌──────────────────┐
│ merge_video_     │
│ chunks()         │
│                  │
│ FFmpeg concat    │
│ demuxer          │
└────┬─────────────┘
     │
     ├─ chunk_0.mp4
     │
     ├─ chunk_1.mp4
     │
     ↓
   result.mp4 (0.5s)


┌─────────────────────────────────────────────────────────┐
│ ИТОГОВОЕ ВРЕМЯ                                          │
└─────────────────────────────────────────────────────────┘

TTS:          3.2s  ████████
Convert:      1.1s  ███
Split:        0.3s  █
Parallel:     6.8s  █████████████████
Merge:        0.5s  █
─────────────────────────────────────
TOTAL:       11.9s

vs Sequential: 16.8s

Ускорение: 1.41x ⚡
```

## 🎯 Выбор стратегии обработки

```
┌────────────────────────────────────────────────────────┐
│                DECISION TREE                            │
└────────────────────────────────────────────────────────┘

                    Audio Duration?
                         │
         ┌───────────────┼───────────────┐
         │               │               │
      < 10s          10-30s           > 30s
         │               │               │
         ↓               ↓               ↓
    Sequential     Parallel 2ch     Parallel 2-4ch
    ════════════   ════════════     ═════════════
    1 model        GAN + NOGAN      GAN + NOGAN
    No overhead    1.5-1.8x speed   1.7-2x speed
    Simple         Optimal          Maximum speed
```

## 📊 Сравнение использования ресурсов

### Sequential (Обычная)

```
GPU Utilization:
┌─────────────────────────────────────┐
│ GAN:  ████████████████████████████  │ 100%
│ NOGAN: ░░░░░░░░░░░░░░░░░░░░░░░░░░░░│ 0%
└─────────────────────────────────────┘

VRAM Usage:
┌─────────────────────────────────────┐
│ GAN:   ████████░░░░░░░░░░░░░░░░░░░░ │ 8GB
│ NOGAN: ████████░░░░░░░░░░░░░░░░░░░░ │ 8GB (loaded but idle)
└─────────────────────────────────────┘

Total: 16GB VRAM (50% idle!)
```

### Parallel (Параллельная)

```
GPU Utilization:
┌─────────────────────────────────────┐
│ GAN:   ████████████████             │ 100%
│ NOGAN: ████████████████             │ 100%
└─────────────────────────────────────┘

VRAM Usage:
┌─────────────────────────────────────┐
│ GAN:   ████████░░░░░░░░░░░░░░░░░░░░ │ 8GB (active)
│ NOGAN: ████████░░░░░░░░░░░░░░░░░░░░ │ 8GB (active)
└─────────────────────────────────────┘

Total: 16GB VRAM (100% utilized! ⚡)
```

## 🚀 Эффективность на разных длительностях

```
Speedup Chart:

2.0x ┤                          ╭─────────
     │                     ╭────╯
1.5x ┤              ╭──────╯
     │         ╭────╯
1.0x ┤─────────╯
     │
0.5x ┤
     │
0.0x └─────┬─────┬─────┬─────┬─────┬─────
           5s    10s   20s   30s   60s
           Audio Duration

Legend:
─────── Parallel Speedup
━━━━━━━ Sequential (baseline)

Sweet spot: 20-60 seconds 🎯
```

## 🎨 Веб-интерфейс (/parallel_test)

```
┌───────────────────────────────────────────────────────┐
│  🚀 Сравнение: Параллельная vs Обычная обработка      │
└───────────────────────────────────────────────────────┘

┌─────────────────────┬─────────────────────┐
│  🚀 Параллельная    │  🎯 Обычная         │
│  (2 модели)         │  (1 модель)         │
├─────────────────────┼─────────────────────┤
│                     │                     │
│ [Текст..........]   │ [Текст..........]   │
│                     │                     │
│ [Язык ▼] [Generate] │ [Язык ▼] [Generate] │
│                     │                     │
│ ⏱️ 9.5s             │ ⏱️ 16.8s            │
│                     │                     │
│ [🎥 Video Player]   │ [🎥 Video Player]   │
│                     │                     │
└─────────────────────┴─────────────────────┘

             Speedup: 1.77x ⚡
```

---

**Легенда:**
- `████` - Активная обработка
- `░░░░` - Idle (простой)
- `▓▓▓▓` - Post-processing
- `⚡` - Ускорение
- `🚀` - Максимальная скорость
