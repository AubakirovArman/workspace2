<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚öôÔ∏è –°–µ–≥–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ</title>
    <style>
        :root {
            color-scheme: light;
        }
        * {
            box-sizing: border-box;
        }
        body {
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2b5876 0%, #4e4376 100%);
            min-height: 100vh;
            padding: 32px 16px;
            color: #1f2933;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #ffffff;
            border-radius: 18px;
            box-shadow: 0 24px 64px rgba(0, 0, 0, 0.25);
            overflow: hidden;
        }
        header {
            background: linear-gradient(135deg, #5b86e5 0%, #36d1dc 100%);
            color: #ffffff;
            padding: 32px 40px;
        }
        header h1 {
            margin: 0;
            font-size: 2.3rem;
        }
        header p {
            margin: 12px 0 0;
            opacity: 0.9;
        }
        main {
            padding: 32px 40px 48px;
        }
        .grid {
            display: grid;
            grid-template-columns: 360px 1fr;
            gap: 32px;
        }
        .card {
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            padding: 24px;
            background: #f8fbff;
        }
        textarea {
            width: 100%;
            min-height: 180px;
            resize: vertical;
            border-radius: 12px;
            border: 1px solid #cbd5e0;
            padding: 12px 14px;
            font-size: 14px;
            line-height: 1.55;
        }
        label {
            display: block;
            font-weight: 600;
            margin-bottom: 6px;
        }
        select, input[type="number"] {
            width: 100%;
            padding: 10px 12px;
            border-radius: 12px;
            border: 1px solid #cbd5e0;
            font-size: 14px;
            background: #ffffff;
        }
        .control-group {
            margin-top: 18px;
        }
        button {
            width: 100%;
            padding: 14px 16px;
            margin-top: 22px;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            background: linear-gradient(135deg, #36d1dc 0%, #5b86e5 100%);
            color: #ffffff;
            box-shadow: 0 12px 32px rgba(91, 134, 229, 0.35);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 16px 40px rgba(91, 134, 229, 0.4);
        }
        button:disabled {
            opacity: 0.55;
            cursor: not-allowed;
        }
        .status-box {
            margin-top: 18px;
            background: #ebf8ff;
            border: 1px solid #bee3f8;
            border-radius: 12px;
            padding: 16px 18px;
            display: none;
        }
        .status-box.active {
            display: block;
        }
        .status-box strong {
            display: block;
            margin-bottom: 6px;
        }
        video {
            width: 100%;
            border-radius: 14px;
            background: #000;
        }
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
            margin-top: 18px;
        }
        .metric-card {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 14px;
            padding: 16px;
        }
        .metric-card h3 {
            margin: 0;
            font-size: 16px;
            color: #2b6cb0;
        }
        .metric-value {
            font-size: 26px;
            font-weight: 700;
            margin-top: 8px;
        }
        .metric-meta {
            margin-top: 6px;
            font-size: 13px;
            color: #4a5568;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 24px;
            background: #ffffff;
            border-radius: 14px;
            overflow: hidden;
        }
        .info-bar {
            display: none;
            justify-content: space-between;
            gap: 12px;
            background: #edf2ff;
            border: 1px solid #c3dafe;
            border-radius: 12px;
            padding: 12px 16px;
            font-size: 13px;
            margin-top: 16px;
            color: #2b437c;
            flex-wrap: wrap;
        }
        th, td {
            padding: 10px 12px;
            border-bottom: 1px solid #edf2f7;
            text-align: left;
            font-size: 13px;
        }
        th {
            background: #f7fafc;
            font-weight: 700;
            color: #2d3748;
        }
        tr:last-child td {
            border-bottom: none;
        }
        .error {
            margin-top: 18px;
            background: #ffecec;
            border: 1px solid #feb2b2;
            color: #c53030;
            padding: 14px 16px;
            border-radius: 12px;
            display: none;
        }
        .error.active {
            display: block;
        }
        @media (max-width: 960px) {
            main {
                padding: 28px 24px 40px;
            }
            .grid {
                grid-template-columns: 1fr;
            }
            .card {
                order: unset;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <header>
        <h1>‚öôÔ∏è –°–µ–≥–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ (16 –ø–æ—Ç–æ–∫–æ–≤)</h1>
        <p>–°—Ü–µ–Ω–∞—Ä–∏–π: Wav2Lip ‚Üí 16 —Å–µ–≥–º–µ–Ω—Ç–æ–≤ FFmpeg ‚Üí —Å–∫–ª–µ–π–∫–∞ ‚Üí –∞—É–¥–∏–æ. –°–ª–µ–¥–∏—Ç–µ –∑–∞ —Ç–∞–π–º–∏–Ω–≥–∞–º–∏ TTS –∏ –∞–≤–∞—Ç–∞—Ä–∞.</p>
    </header>
    <main>
        <div class="grid">
            <section class="card" id="controls">
                <label for="text">–¢–µ–∫—Å—Ç</label>
                <textarea id="text">–î–æ–±—Ä—ã–π –¥–µ–Ω—å! –≠—Ç–æ —Ç–µ—Å—Ç —Å–µ–≥–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è. –ú—ã —Ä–∞–∑–±–∏–≤–∞–µ–º –≤—ã—Ö–æ–¥ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –Ω–∞ —à–µ—Å—Ç–Ω–∞–¥—Ü–∞—Ç—å –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã—Ö —Å–µ–≥–º–µ–Ω—Ç–æ–≤, –∫–æ–¥–∏—Ä—É–µ–º –∏—Ö –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –∏ –∑–∞—Ç–µ–º –æ–±—ä–µ–¥–∏–Ω—è–µ–º –≤ –∏—Ç–æ–≥–æ–≤–æ–µ –≤–∏–¥–µ–æ. –¢–∞–∫ –º—ã –¥–æ—Å—Ç–∏–≥–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Å–∫–æ—Ä–æ—Å—Ç–∏ –ø—Ä–∏ –¥–ª–∏–Ω–Ω—ã—Ö —Ä–æ–ª–∏–∫–∞—Ö.</textarea>
                <div class="control-group">
                    <label for="language">–Ø–∑—ã–∫</label>
                    <select id="language">
                        <option value="ru">üá∑üá∫ –†—É—Å—Å–∫–∏–π</option>
                        <option value="kk">üá∞üáø –ö–∞–∑–∞—Ö—Å–∫–∏–π</option>
                        <option value="en">üá∫üá∏ English</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="batch">Batch size (–∏–Ω—Ñ–µ—Ä–µ–Ω—Å)</label>
                    <input type="number" id="batch" value="4024" min="64" max="2048" step="32">
                </div>
                <button id="run">üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ–≥–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∑–∞–ø—É—Å–∫</button>
                <div class="status-box" id="status-box">
                    <strong>–û–±—Ä–∞–±–æ—Ç–∫–∞...</strong>
                    <div id="status-details">–ì–æ—Ç–æ–≤–∏–º –∞—É–¥–∏–æ –∏ –∞–≤–∞—Ç–∞—Ä</div>
                </div>
                <div class="error" id="error-box"></div>
            </section>
            <section class="card" id="result-card" style="display:none;">
                <video id="preview" controls></video>
                <div class="info-bar" id="info-bar"></div>
                <div class="metrics-grid" id="metrics"></div>
                <table id="segments-table" style="display:none;">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>–ö–∞–¥—Ä—ã</th>
                            <th>–ó–∞–ø–∏—Å—å, s</th>
                            <th>FFmpeg, s</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </section>
        </div>
    </main>
</div>
<script>
const runButton = document.getElementById('run');
const statusBox = document.getElementById('status-box');
const statusDetails = document.getElementById('status-details');
const errorBox = document.getElementById('error-box');
const resultCard = document.getElementById('result-card');
const preview = document.getElementById('preview');
const metricsGrid = document.getElementById('metrics');
const segmentsTable = document.getElementById('segments-table');
const segmentsTableBody = segmentsTable.querySelector('tbody');
const infoBar = document.getElementById('info-bar');

function setLoading(state, message) {
    if (state) {
        statusBox.classList.add('active');
        statusDetails.textContent = message;
        runButton.disabled = true;
    } else {
        statusBox.classList.remove('active');
        runButton.disabled = false;
    }
}

function showError(message) {
    errorBox.textContent = message;
    errorBox.classList.add('active');
}

function resetError() {
    errorBox.textContent = '';
    errorBox.classList.remove('active');
}

function renderMetrics(payload) {
    const timings = payload.timings;
    const totalFrames = payload.total_frames;
    const resolution = payload.resolution;
    const inferenceStats = payload.inference_stats || {};
    const workers = payload.capture_workers || 1;
    const captureChunks = payload.capture_chunks || payload.segments;
    const encoderSegments = Array.isArray(payload.segment_results) ? payload.segment_results.length : payload.segments;
    const avatarMode = payload.avatar_mode || 'static';
    const requestedSegments = payload.requested_segments;

    const inferenceSum = typeof inferenceStats.inference_time === 'number' ? inferenceStats.inference_time : timings.inference_time;
    const inferenceWall = typeof timings.inference_time === 'number' ? timings.inference_time : inferenceSum;

    infoBar.innerHTML = `
        <span>Wav2Lip —Å–µ—Ä–≤–∏—Å–æ–≤: <strong>${workers}</strong></span>
        <span>–°–µ–≥–º–µ–Ω—Ç—ã –∏–Ω—Ñ–µ—Ä–µ–Ω—Å–∞: <strong>${captureChunks}</strong></span>
        <span>FFmpeg —Å–µ–≥–º–µ–Ω—Ç—ã: <strong>${encoderSegments}</strong></span>
        <span>–ó–∞–ø—Ä–æ—à–µ–Ω–æ: <strong>${requestedSegments && requestedSegments > 0 ? requestedSegments : 'auto'}</strong></span>
        <span>–†–µ–∂–∏–º –∞–≤–∞—Ç–∞—Ä–∞: <strong>${avatarMode === 'static' ? '—Å—Ç–∞—Ç–∏—á–Ω—ã–π' : '–≤–∏–¥–µ–æ'}</strong></span>
    `;
    if (avatarMode === 'dynamic' && workers === 1) {
        infoBar.innerHTML += '<span>‚ÑπÔ∏è –í–∏–¥–µ–æ-–∞–≤–∞—Ç–∞—Ä –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏.</span>';
    }
    infoBar.style.display = 'flex';

    metricsGrid.innerHTML = '';
    const cards = [
        {title: 'TTS', value: timings.tts_time, meta: '–°–∏–Ω—Ç–µ–∑ —Ä–µ—á–∏'},
        {title: '–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è WAV', value: timings.audio_convert_time, meta: '–ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –≤ 16 kHz WAV'},
        {title: '–ó–∞—Ö–≤–∞—Ç –∫–∞–¥—Ä–æ–≤', value: timings.capture_time, meta: '–°–±–æ—Ä –∫–∞–¥—Ä–æ–≤ —Å –º–æ–¥–µ–ª–∏'},
    {title: '–ò–Ω—Ñ–µ—Ä–µ–Ω—Å (wall)', value: inferenceWall, meta: workers > 1 ? `–ú–∞–∫—Å. —Å–µ–≥–º–µ–Ω—Ç ¬∑ ${workers} —Å–µ—Ä–≤–∏—Å(–∞)` : '–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ–≥–æ–Ω'},
    {title: '–ò–Ω—Ñ–µ—Ä–µ–Ω—Å (—Å—É–º–º–∞)', value: inferenceSum, meta: workers > 1 ? 'GPU compute —Å—É–º–º–∞—Ä–Ω–æ' : '–°–æ–≤–ø–∞–¥–∞–µ—Ç —Å wall'},
        {title: '–ö–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ', value: timings.encode_time, meta: 'FFmpeg √ó —Å–µ–≥–º–µ–Ω—Ç—ã'},
        {title: '–°–∫–ª–µ–π–∫–∞', value: timings.merge_time, meta: 'concat copy'},
        {title: '–ê—É–¥–∏–æ (mux)', value: timings.audio_mux_time, meta: 'AAC + faststart'},
        {title: '–ê–≤–∞—Ç–∞—Ä', value: timings.avatar_time, meta: '–ò–Ω—Ñ–µ—Ä–µ–Ω—Å + –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ'},
        {title: '–í—Å–µ–≥–æ', value: timings.total_time, meta: `${totalFrames} –∫–∞–¥—Ä–æ–≤ ¬∑ ${resolution.width}√ó${resolution.height}`}
    ];
    cards.forEach(card => {
        if (typeof card.value !== 'number') {
            return;
        }
        const div = document.createElement('div');
        div.className = 'metric-card';
        div.innerHTML = `
            <h3>${card.title}</h3>
            <div class="metric-value">${card.value.toFixed(2)}<span style="font-size:16px;"> s</span></div>
            <div class="metric-meta">${card.meta}</div>
        `;
        metricsGrid.appendChild(div);
    });
}

function renderSegments(segmentResults) {
    if (!Array.isArray(segmentResults) || segmentResults.length === 0) {
        segmentsTable.style.display = 'none';
        return;
    }
    segmentsTableBody.innerHTML = '';
    segmentResults.forEach(item => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${item.index + 1}</td>
            <td>${item.frame_start} ‚Äì ${item.frame_end}</td>
            <td>${item.write_time.toFixed(2)}</td>
            <td>${item.ffmpeg_time.toFixed(2)}</td>
        `;
        if (item.return_code !== 0) {
            row.style.color = '#c53030';
        }
        segmentsTableBody.appendChild(row);
    });
    segmentsTable.style.display = '';
}

runButton.addEventListener('click', async () => {
    resetError();
    resultCard.style.display = 'none';
    infoBar.style.display = 'none';
    infoBar.innerHTML = '';
    const text = document.getElementById('text').value.trim();
    const language = document.getElementById('language').value;
    const batch = Number(document.getElementById('batch').value);

    if (!text) {
        showError('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏.');
        return;
    }
    if (!Number.isFinite(batch) || batch < 64) {
        showError('Batch size –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å ‚â• 64.');
        return;
    }

    setLoading(true, '–ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∞—É–¥–∏–æ...');

    try {
        const response = await fetch('/api/segment/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text, language, batch_size: batch })
        });

        if (!response.ok) {
            const error = await response.json().catch(() => ({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' }));
            throw new Error(error.error || '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
        }

        setLoading(true, '–ö–æ–¥–∏—Ä—É–µ–º —Å–µ–≥–º–µ–Ω—Ç—ã...');
        const payload = await response.json();

    renderMetrics(payload);
        renderSegments(payload.segment_results);

        preview.src = `${payload.video_url}?t=${Date.now()}`;
        preview.load();
        preview.oncanplay = () => {
            preview.play().catch(() => {});
        };

        resultCard.style.display = '';
        setLoading(false);
    } catch (err) {
        setLoading(false);
        showError(err.message);
    }
});
</script>
</body>
</html>
