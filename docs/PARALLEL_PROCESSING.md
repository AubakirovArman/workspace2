# 🚀 Параллельная обработка на двух моделях

## 📊 Обзор

Новая функциональность позволяет **увеличить скорость обработки до ~1.8x** за счёт параллельной работы двух моделей (GAN и NOGAN).

## 🎯 Принцип работы

```
┌─────────────────────────────────────────────────────────┐
│                    Исходное аудио                        │
│                   (например, 30 секунд)                  │
└────────────────────┬────────────────────────────────────┘
                     │
                     ↓
          ┌──────────────────────┐
          │  Разбиение на чанки  │
          └──────────────────────┘
                     │
        ┌────────────┴────────────┐
        ↓                         ↓
┌──────────────┐         ┌──────────────┐
│  Чанк 1      │         │  Чанк 2      │
│  (0-15s)     │         │  (15-30s)    │
└──────┬───────┘         └──────┬───────┘
       │                        │
       ↓                        ↓
┌──────────────┐         ┌──────────────┐
│ GAN модель   │         │ NOGAN модель │
│ обрабатывает │         │ обрабатывает │
└──────┬───────┘         └──────┬───────┘
       │                        │
       ↓                        ↓
┌──────────────┐         ┌──────────────┐
│ Видео 1      │         │ Видео 2      │
│ (0-15s)      │         │ (15-30s)     │
└──────┬───────┘         └──────┬───────┘
       │                        │
       └────────────┬───────────┘
                    ↓
          ┌──────────────────┐
          │  Склейка видео   │
          └──────────────────┘
                    │
                    ↓
          ┌──────────────────┐
          │ Финальное видео  │
          │   (0-30s)        │
          └──────────────────┘
```

## ⚡ Преимущества

### 1. Ускорение обработки
- **Короткие аудио (< 10s)**: нет смысла разбивать
- **Средние аудио (10-30s)**: ускорение ~1.5-1.8x
- **Длинные аудио (> 30s)**: ускорение до ~2x

### 2. Оптимальное использование GPU
- Обе модели загружены в VRAM
- Параллельная работа GPU потоков
- Минимальные простои

### 3. Автоматическое разбиение
- Система сама определяет оптимальное количество чанков
- Учитывает длительность аудио
- Минимизирует overhead от склейки

## 🔧 Использование

### API Endpoint

```bash
POST http://localhost:3000/api/generate_parallel
Content-Type: application/json

{
  "text": "Ваш длинный текст для озвучки",
  "language": "ru",
  "num_workers": 2  // optional, по умолчанию 2
}
```

### Пример с curl

```bash
curl -X POST http://localhost:3000/api/generate_parallel \
  -H "Content-Type: application/json" \
  -d '{
    "text": "Это длинный текст, который будет обработан быстрее благодаря параллельной обработке на двух моделях.",
    "language": "ru"
  }' \
  --output avatar_parallel.mp4
```

### Python пример

```python
import requests

response = requests.post(
    'http://localhost:3000/api/generate_parallel',
    json={
        'text': 'Длинный текст для быстрой обработки',
        'language': 'ru',
        'num_workers': 2
    }
)

if response.status_code == 200:
    with open('result.mp4', 'wb') as f:
        f.write(response.content)
    print('✅ Видео готово!')
else:
    print(f'❌ Ошибка: {response.json()}')
```

## 📊 Сравнение производительности

### Обычная обработка (`/api/generate`)
```
Аудио 20 секунд:
├─ TTS генерация:        3.2s
├─ Конвертация:          1.1s
└─ Lip-sync:            12.5s  ← медленно
   ├─ Загрузка видео:    0.0s (из кэша)
   ├─ Обработка аудио:   2.1s
   ├─ Детекция лица:     0.0s (из кэша)
   └─ Инференс модели:  10.3s
─────────────────────────────
ИТОГО:                  16.8s
```

### Параллельная обработка (`/api/generate_parallel`)
```
Аудио 20 секунд:
├─ TTS генерация:        3.2s
├─ Конвертация:          1.1s
├─ Разбиение аудио:      0.3s
├─ Параллельная обработка: 6.8s  ← быстро!
│  ├─ GAN  (чанк 1):     6.5s │
│  └─ NOGAN (чанк 2):    6.8s │ ← параллельно
└─ Склейка видео:        0.5s
─────────────────────────────
ИТОГО:                  11.9s
Ускорение:              1.41x
```

## ⚙️ Технические детали

### Требования
- ✅ Обе модели загружены (GAN + NOGAN)
- ✅ Достаточно VRAM для двух моделей
- ✅ Статический режим аватара (рекомендуется)

### Ограничения
- Обе модели должны быть инициализированы при запуске
- Минимальная длительность аудио: 10s (иначе нет смысла)
- Может потребоваться больше VRAM (~2x от одной модели)

### Оптимизации
1. **Умное разбиение**: каждый чанк ~15 секунд
2. **Кэширование лица**: используется предзагруженное лицо
3. **Быстрая склейка**: ffmpeg concat без перекодирования
4. **ThreadPoolExecutor**: параллельная обработка Python-level

## 🎛️ Настройка

### Количество воркеров

```python
# По умолчанию (автоматически)
optimal_chunks = estimate_optimal_chunks(audio_duration, num_models=2)

# Вручную
{
  "num_workers": 2  // Фиксированное количество
}
```

### Алгоритм определения количества чанков

```python
def estimate_optimal_chunks(audio_duration_seconds, num_models=2):
    # Короткие аудио (< 10s) - не разбиваем
    if audio_duration_seconds < 10:
        return 1
    
    # Средние (10-30s) - 2 чанка
    if audio_duration_seconds < 30:
        return min(2, num_models)
    
    # Длинные - каждый чанк ~15s, но не более num_models * 2
    optimal = min(
        int(audio_duration_seconds / 15),
        num_models * 2
    )
    return max(2, optimal)
```

## 🔄 Workflow

### 1. Проверка готовности
```python
GET /api/health

Response:
{
  "status": "ready",
  "gan_model_loaded": true,   ← Обе модели
  "nogan_model_loaded": true,  ← должны быть true
  ...
}
```

### 2. Отправка запроса
```python
POST /api/generate_parallel
{
  "text": "...",
  "language": "ru"
}
```

### 3. Получение результата
- Прямой возврат MP4 файла
- Временные файлы автоматически удаляются

## 📈 Когда использовать?

### ✅ Используйте параллельную обработку когда:
- Длинные тексты (> 10 секунд аудио)
- Обе модели загружены и работают
- Достаточно VRAM
- Нужна максимальная скорость

### ❌ НЕ используйте когда:
- Короткие тексты (< 10 секунд)
- Доступна только одна модель
- Ограничена VRAM
- Простой последовательной обработки достаточно

## 🐛 Troubleshooting

### Ошибка: "Для параллельной обработки требуются обе модели"

**Причина**: Не загружена одна из моделей (GAN или NOGAN)

**Решение**:
1. Проверьте наличие обоих файлов:
   - `Wav2Lip-SD-GAN.pt`
   - `Wav2Lip-SD-NOGAN.pt`
2. Убедитесь, что они указаны в `.env`:
   ```bash
   CHECKPOINT_PATH_GAN=/workspace/workspace2/Wav2Lip-SD-GAN.pt
   CHECKPOINT_PATH_NOGAN=/workspace/workspace2/Wav2Lip-SD-NOGAN.pt
   ```
3. Перезапустите сервер

### Ошибка: "CUDA out of memory"

**Причина**: Недостаточно VRAM для двух моделей

**Решение**:
1. Используйте обычный endpoint `/api/generate`
2. Или уменьшите batch_size в конфиге
3. Или освободите VRAM, закрыв другие приложения

### Артефакты на стыках чанков

**Причина**: Проблемы при склейке видео

**Решение**:
- Обычно редко встречается благодаря точной работе ffmpeg
- Если возникает - уменьшите количество чанков

## 📝 Логи

```
🚀 ПАРАЛЛЕЛЬНАЯ ГЕНЕРАЦИЯ (2 модели)
============================================================
Текст: Длинный текст...
Язык: ru
Воркеры: 2
📊 Длительность аудио: 22.50s
📦 Оптимальное разбиение: 2 чанков
📦 Разбиваем аудио на 2 частей...
✅ Аудио разбито за 0.25s
🚀 Запуск параллельной обработки на 2 моделях...
   - Чанк 0: 0.00s-11.25s → GAN
   - Чанк 1: 11.25s-22.50s → NOGAN
   ✅ Чанк 0 готов
   ✅ Чанк 1 готов
✅ Все чанки обработаны за 6.82s
🎬 Склеиваем видео чанки...
✅ Видео склеено за 0.48s
🧹 Очистка временных файлов...

📊 Статистика параллельной обработки:
   TTS генерация:       3.21s
   Конвертация:         1.08s
   Разбиение аудио:     0.25s
   Параллельная обработка: 6.82s
   Склейка видео:       0.48s
   Количество чанков: 2
   ─────────────────────────
   ИТОГО:              11.84s
   Ускорение:          ~1.5-2x vs sequential

✅ Видео готово: /workspace/workspace2/outputs/avatar_parallel_...
```

## 🎓 Дополнительная информация

### Архитектура
- `app_core/services/parallel_lipsync.py` - модуль параллельной обработки
- `app_core/routes/api.py` - endpoint `/api/generate_parallel`
- `modern-lipsync/service.py` - метод `process_with_preloaded()`

### Зависимости
- `ThreadPoolExecutor` - параллельная обработка
- `pydub` - разбиение аудио
- `ffmpeg` - склейка видео (concat demuxer)

---

**Автор**: AI Assistant  
**Дата**: 31 октября 2025  
**Версия**: 1.0
