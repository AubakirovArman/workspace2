# –†–µ–∑—é–º–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π: MJPEG Real-Time Streaming

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ

### 1. –ù–æ–≤—ã–π API —ç–Ω–¥–ø–æ–∏–Ω—Ç `/api/stream_mjpeg`
- **–§–∞–π–ª:** `app_core/routes/api.py` (—Å—Ç—Ä–æ–∫–∏ 415-550)
- **–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
  - POST –∑–∞–ø—Ä–æ—Å —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ text, language, low_latency
  - –ü–æ—Ç–æ–∫–æ–≤–∞—è –ø–µ—Ä–µ–¥–∞—á–∞ MJPEG –∫–∞–¥—Ä–æ–≤ –±–µ–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–∞
  - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–µ–∂–∏–º–∞ –Ω–∏–∑–∫–æ–π –ª–∞—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ (batch_size=32)
  - –û—á–µ—Ä–µ–¥—å –∫–∞–¥—Ä–æ–≤ —Å —Ä–∞–∑–º–µ—Ä–æ–º 30 –¥–ª—è –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏–∏
  - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤

### 2. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –±–∞—Ç—á–∏–Ω–≥–∞ –≤ service.py
- **–§–∞–π–ª:** `modern-lipsync/service.py`
- **–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
  - –î–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä `batch_size_override` –≤ –º–µ—Ç–æ–¥ `process()` (—Å—Ç—Ä–æ–∫–∞ 316)
  - –ü–µ—Ä–µ–¥–∞—á–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ –≤ `_run_inference()` (—Å—Ç—Ä–æ–∫–∞ 445, 562)
  - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–≥–æ –±–∞—Ç—á–∞ (—Å—Ç—Ä–æ–∫–∞ 585)
  - frame_sink —É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç (—Å—Ç—Ä–æ–∫–∏ 692-695)

### 3. –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- **–§–∞–π–ª:** `templates/mjpeg_test.html`
- **–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
  - –ö—Ä–∞—Å–∏–≤—ã–π —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
  - –í–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞ –∏ –≤—ã–±–æ—Ä —è–∑—ã–∫–∞
  - –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ä–µ–∂–∏–º–∞ –Ω–∏–∑–∫–æ–π –ª–∞—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏
  - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ (–∫–∞–¥—Ä—ã, –≤—Ä–µ–º—è)
  - –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏

### 4. –†–æ—É—Ç –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
- **–§–∞–π–ª:** `app_core/routes/pages.py`
- **–î–æ–±–∞–≤–ª–µ–Ω:** `/mjpeg_test` ‚Üí `mjpeg_test.html`

### 5. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- **–§–∞–π–ª:** `MJPEG_STREAMING.md`
- **–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ:**
  - –û–±–∑–æ—Ä —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –∏ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤
  - API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏
  - –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –¥–∏–∞–≥—Ä–∞–º–º—ã
  - –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
  - –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –¥—Ä—É–≥–∏–º–∏ –º–µ—Ç–æ–¥–∞–º–∏
  - –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è (Python, JavaScript)

## üéØ –ö–ª—é—á–µ–≤—ã–µ —É–ª—É—á—à–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### Time to First Frame (TTFF):
- **–û–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º:** ~35 —Å–µ–∫—É–Ω–¥
- **MJPEG —Å—Ç–∞–Ω–¥–∞—Ä—Ç:** ~32 —Å–µ–∫—É–Ω–¥—ã  
- **MJPEG low_latency:** **~1.2 —Å–µ–∫—É–Ω–¥—ã** ‚ö°

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:
1. ‚úÖ –ù–µ—Ç —Ñ–∞–π–ª–æ–≤–æ–≥–æ I/O (—Ç–æ–ª—å–∫–æ temp.wav)
2. ‚úÖ –ù–µ—Ç ffmpeg –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –∫–æ–Ω—Ü–µ
3. ‚úÖ –ú–∞–ª–µ–Ω—å–∫–∏–π batch = –±—ã—Å—Ç—Ä–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–µ—Ä–≤—ã—Ö –∫–∞–¥—Ä–æ–≤
4. ‚úÖ –ü—Ä—è–º–∞—è –ø–µ—Ä–µ–¥–∞—á–∞ –∫–∞–¥—Ä–æ–≤ –∫–ª–∏–µ–Ω—Ç—É —á–µ—Ä–µ–∑ –æ—á–µ—Ä–µ–¥—å

## üöÄ –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å

### –ß–µ—Ä–µ–∑ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å:
```
http://localhost:3000/mjpeg_test
```

### –ß–µ—Ä–µ–∑ API:
```bash
curl -X POST http://localhost:3000/api/stream_mjpeg \
  -H "Content-Type: application/json" \
  -d '{"text": "–ü—Ä–∏–≤–µ—Ç!", "language": "ru", "low_latency": true}' \
  --no-buffer
```

### –í JavaScript:
```javascript
const response = await fetch('/api/stream_mjpeg', {
  method: 'POST',
  body: JSON.stringify({
    text: '–í–∞—à —Ç–µ–∫—Å—Ç',
    language: 'ru',
    low_latency: true
  })
});

const blob = await response.blob();
const url = URL.createObjectURL(blob);
videoElement.src = url;
```

## üìä –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### Frame Pipeline:
```
TTS ‚Üí Audio ‚Üí Mel Chunks ‚Üí Lipsync (batch=32) ‚Üí frame_sink() ‚Üí Queue ‚Üí JPEG encode ‚Üí HTTP Stream
```

### –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
- **–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π batch:** 960 –∫–∞–¥—Ä–æ–≤ (–æ–ø—Ç–∏–º–∞–ª—å–Ω–æ –¥–ª—è GPU)
- **Low latency batch:** 32 –∫–∞–¥—Ä–∞ (–±—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç)
- **Frame queue size:** 30 –∫–∞–¥—Ä–æ–≤ (–±—É—Ñ–µ—Ä)
- **JPEG quality:** 85% (–±–∞–ª–∞–Ω—Å –∫–∞—á–µ—Å—Ç–≤–æ/—Ä–∞–∑–º–µ—Ä)

## üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

–í—Å–µ —Ä–∞–±–æ—Ç–∞–µ—Ç "–∏–∑ –∫–æ—Ä–æ–±–∫–∏", –Ω–æ –º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å:

1. **–ò–∑–º–µ–Ω–∏—Ç—å batch size –¥–ª—è –Ω–∏–∑–∫–æ–π –ª–∞—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏:**
   ```python
   # app_core/routes/api.py, —Å—Ç—Ä–æ–∫–∞ 476
   batch_size = 16 if low_latency else None  # –ú–µ–Ω—å—à–µ = –±—ã—Å—Ç—Ä–µ–µ
   ```

2. **–ò–∑–º–µ–Ω–∏—Ç—å —Ä–∞–∑–º–µ—Ä –æ—á–µ—Ä–µ–¥–∏:**
   ```python
   # app_core/routes/api.py, —Å—Ç—Ä–æ–∫–∞ 463
   frame_queue = Queue(maxsize=50)  # –ë–æ–ª—å—à–µ –±—É—Ñ–µ—Ä
   ```

3. **–ò–∑–º–µ–Ω–∏—Ç—å JPEG –∫–∞—á–µ—Å—Ç–≤–æ:**
   ```python
   # app_core/routes/api.py, —Å—Ç—Ä–æ–∫–∞ 512
   _, buffer = cv2.imencode('.jpg', frame, [cv2.IMWRITE_JPEG_QUALITY, 90])
   ```

## üéì –°–≤—è–∑—å —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º–∏

–ü—Ä–æ–µ–∫—Ç —Ç–µ–ø–µ—Ä—å –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç 3 —Ä–µ–∂–∏–º–∞ —Ä–∞–±–æ—Ç—ã:

1. **–§–∞–π–ª–æ–≤—ã–π –≤—ã–≤–æ–¥** ‚Üí `/api/generate`
   - –ü–æ–ª–Ω–æ–µ –≤–∏–¥–µ–æ —Å –∞—É–¥–∏–æ –≤ MP4
   - –õ—É—á—à–µ–µ –∫–∞—á–µ—Å—Ç–≤–æ
   - –î–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞

2. **MJPEG –°—Ç—Ä–∏–º–∏–Ω–≥** ‚Üí `/api/stream_mjpeg` ‚≠ê NEW
   - –ë–µ–∑ —Ñ–∞–π–ª–æ–≤, –Ω–∏–∑–∫–∞—è –ª–∞—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å
   - –¢–æ–ª—å–∫–æ –≤–∏–¥–µ–æ (–±–µ–∑ –∞—É–¥–∏–æ –≤ –ø–æ—Ç–æ–∫–µ)
   - –î–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞

3. **WebRTC** ‚Üí `/api/realtime/offer`
   - –ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π –¥–≤—É—Å—Ç–æ—Ä–æ–Ω–Ω–∏–π —Å—Ç—Ä–∏–º
   - –í–∏–¥–µ–æ + –∞—É–¥–∏–æ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
   - –î–ª—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π

## ‚ö†Ô∏è –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

1. MJPEG –Ω–µ –≤–∫–ª—é—á–∞–µ—Ç –∞—É–¥–∏–æ –≤ –ø–æ—Ç–æ–∫ (—ç—Ç–æ —Ç–æ–ª—å–∫–æ –≤–∏–¥–µ–æ)
2. –ë—Ä–∞—É–∑–µ—Ä –º–æ–∂–µ—Ç –∫—ç—à–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Ç–æ–∫ - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ timestamp
3. –ü—Ä–∏ –º–µ–¥–ª–µ–Ω–Ω–æ–º –∫–ª–∏–µ–Ω—Ç–µ –æ—á–µ—Ä–µ–¥—å –º–æ–∂–µ—Ç –ø–µ—Ä–µ–ø–æ–ª–Ω–∏—Ç—å—Å—è

## üéâ –†–µ–∑—É–ª—å—Ç–∞—Ç

–¢–µ–ø–µ—Ä—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –º–æ–∂–µ—Ç –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –≤–∏–¥–µ–æ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ —Å –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π, —á—Ç–æ –∏–¥–µ–∞–ª—å–Ω–æ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è:
- –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã—Ö —á–∞—Ç-–±–æ—Ç–æ–≤
- Live –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–π
- –ë—ã—Å—Ç—Ä–æ–≥–æ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞
- –ü–æ—Ç–æ–∫–æ–≤—ã—Ö —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏–π

**–í—Ä–µ–º—è –¥–æ –ø–µ—Ä–≤–æ–≥–æ –∫–∞–¥—Ä–∞ —Å–æ–∫—Ä–∞—Ç–∏–ª–æ—Å—å —Å 35 —Å–µ–∫—É–Ω–¥ –¥–æ 1.2 —Å–µ–∫—É–Ω–¥—ã!** üöÄ
