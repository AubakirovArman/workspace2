# 🔌 API Архитектура - Визуальная Схема

## 🎯 Общая Структура

```
┌────────────────────────────────────────────────────────────────┐
│                     ВНЕШНИЕ КЛИЕНТЫ                            │
│  (Веб-сайты, мобильные приложения, другие сервисы)           │
└────────────────────────────────────────────────────────────────┘
                              │
                              │ HTTP/REST API
                              ▼
┌────────────────────────────────────────────────────────────────┐
│                    FLASK API SERVER                            │
│                  (localhost:3000)                              │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐ │
│  │  POST /api/stream_chunks                                 │ │
│  │  • Принимает: text, language, chunk_size                │ │
│  │  • Возвращает: JSON с URL'ами чанков                    │ │
│  └──────────────────────────────────────────────────────────┘ │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐ │
│  │  GET /api/chunk/video/{id}                              │ │
│  │  • Возвращает: MP4 видео файл                           │ │
│  └──────────────────────────────────────────────────────────┘ │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐ │
│  │  GET /api/chunk/audio/{id}                              │ │
│  │  • Возвращает: WAV аудио файл                           │ │
│  └──────────────────────────────────────────────────────────┘ │
└────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌────────────────────────────────────────────────────────────────┐
│                   ОБРАБОТКА ЗАПРОСА                            │
└────────────────────────────────────────────────────────────────┘
```

---

## 🔄 Поток Обработки Запроса

```
1. ПОЛУЧЕНИЕ ЗАПРОСА
   ┌─────────────────────────┐
   │  POST /api/stream_chunks│
   │  {                      │
   │    "text": "...",       │
   │    "language": "ru",    │
   │    "chunk_size": 15     │
   │  }                      │
   └─────────────────────────┘
              │
              ▼
2. РАЗБИЕНИЕ НА ЧАНКИ
   ┌─────────────────────────┐
   │  Текст → Слова → Чанки  │
   │                         │
   │  "Привет мир..."        │
   │        ↓                │
   │  ["Привет мир",         │
   │   "это тест",           │
   │   "для API"]            │
   └─────────────────────────┘
              │
              ▼
3. ДЛЯ КАЖДОГО ЧАНКА (параллельно):
   
   ┌──────────────────────────────────────┐
   │  A. TTS ГЕНЕРАЦИЯ                   │
   │  ┌────────────────────────────────┐ │
   │  │ TTS API                        │ │
   │  │ https://tts.sk-ai.kz          │ │
   │  │                                │ │
   │  │ Текст → MP3 (2-3 сек)         │ │
   │  └────────────────────────────────┘ │
   └──────────────────────────────────────┘
              │
              ▼
   ┌──────────────────────────────────────┐
   │  B. АУДИО КОНВЕРТАЦИЯ               │
   │  ┌────────────────────────────────┐ │
   │  │ ffmpeg                         │ │
   │  │                                │ │
   │  │ MP3 → WAV 16kHz mono          │ │
   │  └────────────────────────────────┘ │
   └──────────────────────────────────────┘
              │
              ▼
   ┌──────────────────────────────────────┐
   │  C. ВИДЕО ГЕНЕРАЦИЯ                 │
   │  ┌────────────────────────────────┐ │
   │  │ Wav2Lip Service                │ │
   │  │ (GPU/CUDA)                     │ │
   │  │                                │ │
   │  │ 1. Face Detection (batch=8)   │ │
   │  │    Avatar.jpg → Face coords   │ │
   │  │                                │ │
   │  │ 2. Wav2Lip Model (batch=64)   │ │
   │  │    Face + Audio → Lip-sync    │ │
   │  │                                │ │
   │  │ 3. ffmpeg Assembly            │ │
   │  │    Frames + Audio → MP4       │ │
   │  └────────────────────────────────┘ │
   │                                     │
   │  (2-3 сек на GPU)                   │
   └──────────────────────────────────────┘
              │
              ▼
   ┌──────────────────────────────────────┐
   │  D. СОХРАНЕНИЕ                      │
   │  ┌────────────────────────────────┐ │
   │  │ /workspace/outputs/            │ │
   │  │                                │ │
   │  │ • chunk_video_{id}.mp4        │ │
   │  │ • chunk_audio_{id}.wav        │ │
   │  └────────────────────────────────┘ │
   └──────────────────────────────────────┘
              │
              ▼
4. ФОРМИРОВАНИЕ ОТВЕТА
   ┌─────────────────────────┐
   │  JSON Response          │
   │  {                      │
   │    "chunks": [          │
   │      {                  │
   │        "index": 0,      │
   │        "text": "...",   │
   │        "video_url": "..│
   │        "audio_url": "..│
   │        "duration": 3.5  │
   │      }                  │
   │    ]                    │
   │  }                      │
   └─────────────────────────┘
```

---

## 🎬 Детальная Схема Обработки Чанка

```
┌─────────────────────────────────────────────────────────┐
│                    ОБРАБОТКА ЧАНКА                      │
│                  (Один текстовый чанк)                  │
└─────────────────────────────────────────────────────────┘
                          │
        ┌─────────────────┼─────────────────┐
        │                 │                 │
        ▼                 ▼                 ▼
    ┌───────┐       ┌─────────┐      ┌──────────┐
    │ TTS   │       │ Convert │      │ Lipsync  │
    │ 2-3s  │  →    │ 0.1s    │  →   │ 2-3s     │
    └───────┘       └─────────┘      └──────────┘
        │                 │                 │
        ▼                 ▼                 ▼
    MP3 Data          WAV File          MP4 Video
    (bytes)           (temp/)           (outputs/)
                                            │
                                            ▼
                                    ┌──────────────┐
                                    │ Chunk Ready  │
                                    │              │
                                    │ • Video URL  │
                                    │ • Audio URL  │
                                    │ • Duration   │
                                    └──────────────┘
```

---

## 🔧 Компоненты Системы

```
┌────────────────────────────────────────────────────────────┐
│                   ПРЕДЗАГРУЖЕННЫЕ МОДЕЛИ                   │
│                    (Хранятся в памяти)                     │
├────────────────────────────────────────────────────────────┤
│                                                            │
│  ┌──────────────────────────────────────────────────────┐ │
│  │  Wav2Lip-SD-GAN Model                                │ │
│  │  • Размер: 139 MB                                    │ │
│  │  • Устройство: CUDA                                  │ │
│  │  • Загружено 1 раз при старте                       │ │
│  └──────────────────────────────────────────────────────┘ │
│                                                            │
│  ┌──────────────────────────────────────────────────────┐ │
│  │  Face Detection Model (S3FD)                         │ │
│  │  • Размер: 90 MB                                     │ │
│  │  • Устройство: CUDA                                  │ │
│  │  • Предобработка: Avatar.jpg → Face coords          │ │
│  └──────────────────────────────────────────────────────┘ │
│                                                            │
│  ┌──────────────────────────────────────────────────────┐ │
│  │  Avatar Image                                        │ │
│  │  • Файл: avatar.jpg (36 KB)                         │ │
│  │  • Размер: 757x567px                                │ │
│  │  • Предзагружен в OpenCV формат                     │ │
│  └──────────────────────────────────────────────────────┘ │
└────────────────────────────────────────────────────────────┘
```

---

## 📊 API Endpoints Дерево

```
http://localhost:3000
│
├── /                           GET     Главная страница (Download)
├── /realtime                   GET     Realtime страница
├── /api-test                   GET     API Test страница
│
├── /api/
│   ├── health                  GET     Проверка статуса
│   │                                   → { status, models_loaded, device }
│   │
│   ├── generate                POST    Полное видео (старый API)
│   │                                   → video/mp4 file
│   │
│   ├── generate_stream         POST    Realtime чанк (старый API)
│   │                                   → video/mp4 file
│   │
│   ├── stream_chunks           POST    🆕 API для интеграции
│   │                                   ┌─ Input: text, language, chunk_size
│   │                                   └─ Output: JSON с chunks[]
│   │
│   ├── chunk/
│   │   ├── video/{id}          GET     🆕 Получить видео чанк
│   │   │                               → video/mp4
│   │   │
│   │   └── audio/{id}          GET     🆕 Получить аудио чанк
│   │                                   → audio/wav
│   │
│   ├── avatar                  GET     Изображение аватара
│   │                                   → image/jpeg
│   │
│   └── cleanup                 POST    Очистка старых файлов
│                                       → { message }
```

---

## 🌐 Интеграция с Внешними Сервисами

```
┌──────────────────────────────────────────────────────────────┐
│                    ВНЕШНИЙ ВЕБ-САЙТ                          │
└──────────────────────────────────────────────────────────────┘
                          │
                          │ 1. POST запрос
                          ▼
        ┌─────────────────────────────────────┐
        │  /api/stream_chunks                 │
        │  { text: "...", language: "ru" }    │
        └─────────────────────────────────────┘
                          │
                          │ 2. Ответ с URL'ами
                          ▼
        ┌─────────────────────────────────────┐
        │  { chunks: [                        │
        │    { video_url: "/api/chunk/...",   │
        │      audio_url: "/api/chunk/..." }  │
        │  ]}                                  │
        └─────────────────────────────────────┘
                          │
         ┌────────────────┴────────────────┐
         │                                 │
         │ 3. Получение чанков             │
         ▼                                 ▼
┌──────────────────┐            ┌──────────────────┐
│ GET video_url    │            │ GET audio_url    │
│ → MP4 video      │            │ → WAV audio      │
└──────────────────┘            └──────────────────┘
         │                                 │
         └────────────────┬────────────────┘
                          │
                          ▼
        ┌─────────────────────────────────────┐
        │  4. Воспроизведение на сайте        │
        │  <video>, <audio>                   │
        └─────────────────────────────────────┘
```

---

## 💾 Файловая Система

```
/workspace/
│
├── app.py                      # Flask сервер с API
│
├── templates/
│   ├── index.html             # Download страница
│   ├── realtime.html          # Realtime страница
│   └── api_test.html          # 🆕 API Test страница
│
├── outputs/                    # Сгенерированные файлы
│   ├── chunk_video_*.mp4      # Видео чанки
│   ├── chunk_audio_*.wav      # Аудио чанки
│   └── avatar_*.mp4           # Полные видео
│
├── temp_web/                   # Временные файлы
│   ├── chunk_*.wav            # Temp WAV (удаляются)
│   └── temp_*.mp3             # Temp MP3 (удаляются)
│
├── modern-lipsync/             # Wav2Lip модули
│   ├── service.py             # LipsyncService
│   ├── models/                # Нейросети
│   ├── face_detection/        # Детекция лиц
│   └── utils/                 # Утилиты
│
├── avatar.jpg                  # Предзагруженный аватар
├── Wav2Lip-SD-GAN.pt          # Предзагруженная модель
│
└── Документация:
    ├── API_INTEGRATION.md     # 🆕 Полная документация API
    ├── API_QUICKSTART.md      # 🆕 Быстрый старт
    ├── API_COMPLETE.md        # 🆕 Сводка реализации
    └── test_api_integration.py # 🆕 Тестовый скрипт
```

---

## ⚡ Производительность

```
Один чанк (15 слов):
┌─────────────┬──────────┬────────────────────┐
│  Этап       │  Время   │  Где выполняется   │
├─────────────┼──────────┼────────────────────┤
│ TTS API     │  2-3 сек │  Внешний API       │
│ Convert     │  0.1 сек │  ffmpeg (CPU)      │
│ Face Detect │  0.5 сек │  GPU (batch=8)     │
│ Wav2Lip     │  2-3 сек │  GPU (batch=64)    │
│ Assembly    │  0.5 сек │  ffmpeg (CPU)      │
├─────────────┼──────────┼────────────────────┤
│ ИТОГО       │  5-7 сек │  (на чанк)         │
└─────────────┴──────────┴────────────────────┘

Текст 100 слов (~7 чанков):
• Последовательно: 35-49 сек
• Средний темп: 0.7 сек/слово
```

---

## 🔒 Безопасность и Ограничения

```
┌────────────────────────────────────────────────┐
│  АВТООЧИСТКА                                   │
│  • Файлы в outputs/ удаляются через 1 час     │
│  • POST /api/cleanup - ручная очистка         │
└────────────────────────────────────────────────┘

┌────────────────────────────────────────────────┐
│  CORS                                          │
│  • Разрешено для всех доменов                 │
│  • Можно ограничить в production              │
└────────────────────────────────────────────────┘

┌────────────────────────────────────────────────┐
│  ВАЛИДАЦИЯ                                     │
│  • Проверка наличия text                      │
│  • Язык: только ru, kk, en                    │
│  • chunk_size: 5-30 слов                      │
└────────────────────────────────────────────────┘

┌────────────────────────────────────────────────┐
│  TIMEOUT                                       │
│  • TTS API: 30 сек                            │
│  • Генерация видео: без ограничений           │
└────────────────────────────────────────────────┘
```

---

## 🎯 Готово к Использованию!

```
┌──────────────────────────────────────────────┐
│  ✅ API реализован полностью                 │
│  ✅ Документация создана                     │
│  ✅ Тестовая страница работает               │
│  ✅ Python скрипт готов                      │
│  ✅ Примеры интеграции написаны              │
└──────────────────────────────────────────────┘

    🚀 Запуск: python app.py
    🌐 URL: http://localhost:3000
    🧪 Тест: http://localhost:3000/api-test
```

---

**Система готова к интеграции с любыми внешними сервисами!** 🎉
